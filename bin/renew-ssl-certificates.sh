#!/bin/bash

set -e

DRY_RUN=false

# –û–±—Ä–æ–±–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
for arg in "$@"; do
  case $arg in
    --dry-run) DRY_RUN=true ;;
    *)
      echo "‚ùå –ù–µ–≤—ñ–¥–æ–º–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç: $arg"
      exit 1
      ;;
  esac
done

if $DRY_RUN; then
  echo "üîÑ –í–∏–∫–æ–Ω—É—î–º–æ —Ç–µ—Å—Ç–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (dry-run)..."
  sudo certbot renew --dry-run --quiet
else
  echo "üîÑ –ü–æ—á–∏–Ω–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ Certbot..."
  sudo certbot renew --quiet
fi

STATUS=$?

if [[ $STATUS -ne 0 ]]; then
  echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ Certbot (–∫–æ–¥ $STATUS)"
  exit $STATUS
fi

if ! $DRY_RUN; then
  echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ –∞–±–æ –∑–∞–ª–∏—à–∏–ª–∏—Å—å –∞–∫—Ç—É–∞–ª—å–Ω–∏–º–∏."
  echo "üîÅ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó NGINX..."

  if sudo nginx -t; then
    echo "‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è NGINX –≤–∞–ª—ñ–¥–Ω–∞. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ NGINX..."
    sudo systemctl reload nginx
    echo "‚úÖ NGINX –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ."
  else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ —É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó NGINX. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ."
    exit 1
  fi
else
  echo "‚ÑπÔ∏è –¢–µ—Å—Ç–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
fi
